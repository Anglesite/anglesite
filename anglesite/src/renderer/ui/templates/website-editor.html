<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; style-src 'self' 'unsafe-inline';"
    />
    <title>Website Editor</title>
    <link rel="stylesheet" href="default-theme.css" />
    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
      }

      .main-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      .left-panel {
        width: 240px;
        min-width: 240px;
        max-width: 240px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-primary);
        overflow-y: auto;
        flex-shrink: 0;
      }

      .content-with-toolbar {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }

      .toolbar {
        height: 48px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 8px;
        flex-shrink: 0;
      }

      .panel-header {
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-secondary);
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 500;
        text-align: center;
      }

      .panel-content {
        padding: 8px;
        overflow-y: auto;
        height: 100%;
      }

      .center-right-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .center-panel {
        flex: 1;
        background: var(--bg-primary);
        overflow: hidden;
        position: relative;
        min-width: 0;
      }

      .center-content {
        height: 100%;
        overflow: hidden;
      }

      .right-panel {
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-primary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        flex-shrink: 0;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-list .file-list {
        padding-left: 20px;
        margin-top: 2px;
      }

      .file-item {
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        margin-bottom: 2px;
        list-style: none;
        position: relative;
      }

      .file-item-content {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .file-item > .file-list {
        margin-top: 2px;
        margin-bottom: 2px;
      }

      .file-item.collapsed > .file-list {
        display: none;
      }

      .file-item:hover {
        background: var(--button-hover);
      }

      .file-item.selected {
        background: var(--button-active);
        font-weight: 500;
      }

      .disclosure-triangle {
        width: 12px;
        height: 12px;
        display: inline-block;
        cursor: pointer;
        user-select: none;
        transition: transform 0.2s ease;
        font-size: 10px;
        line-height: 12px;
        text-align: center;
        transform: rotate(90deg); /* Default: expanded (▶ rotated 90° = ▼) */
      }

      .disclosure-triangle.collapsed {
        transform: rotate(0deg); /* Collapsed: ▶ pointing right */
      }

      .file-item-content.directory {
        cursor: pointer;
      }

      .file-item i {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .property-item {
        padding: 4px 8px;
        font-size: 12px;
        border-bottom: 1px solid var(--border-secondary);
      }

      .property-label {
        font-weight: 500;
        color: var(--text-secondary);
      }

      .property-value {
        margin-top: 2px;
        color: var(--text-primary);
      }

      .editor-area {
        width: 100%;
        height: 100%;
        border: none;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: monospace;
        font-size: 14px;
        padding: 16px;
        box-sizing: border-box;
        resize: none;
      }

      .preview-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-style: italic;
      }

      /* Ace Editor styles */
      .ace-editor {
        width: 100%;
        height: 100%;
        display: none;
        font-size: 14px;
      }

      .ace-editor.active {
        display: block;
      }

      .preview-placeholder.active {
        display: flex;
      }

      .preview-placeholder:not(.active) {
        display: none;
      }

      /* Sample toolbar buttons */
      .toolbar-button {
        background: var(--button-bg);
        border: 1px solid var(--border-primary);
        border-radius: 3px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 11px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .toolbar-button:hover {
        background: var(--button-hover);
      }

      .toolbar-button i {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }

      .toolbar-separator {
        width: 1px;
        height: 20px;
        background: var(--border-primary);
        margin: 0 4px;
      }

      /* Accessibility styles */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--button-bg);
        color: var(--text-primary);
        padding: 8px;
        text-decoration: none;
        border: 2px solid var(--border-primary);
        border-radius: 4px;
        z-index: 1000;
        transition: top 0.3s;
      }

      .skip-link:focus {
        top: 6px;
      }

      .preview-placeholder,
      .ace-editor,
      .editor-area {
        width: 100%;
        height: 100%;
      }

      .ace-editor {
        display: none;
      }

      .preview-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 16px;
      }

      .panel-section {
        border-bottom: 1px solid var(--border-secondary);
        flex-shrink: 0;
      }

      .panel-section:first-child {
        flex: 0 0 auto;
        max-height: 350px;
        overflow-y: auto;
      }

      .panel-section:last-child {
        border-bottom: none;
        flex: 1;
        overflow-y: auto;
      }

      .panel-section-title {
        background: var(--bg-tertiary);
        padding: 12px 16px;
        margin: 0;
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-secondary);
      }

      .panel-content {
        padding: 16px;
      }

      .property-list {
        margin: 0;
      }

      .property-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 8px;
      }

      .property-item:last-child {
        margin-bottom: 0;
      }

      .property-label {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
        font-weight: 500;
        margin: 0;
        min-width: 80px;
      }

      .property-value {
        font-size: var(--font-size-xs);
        color: var(--text-primary);
        margin: 0;
        text-align: right;
        word-break: break-all;
        flex: 1;
      }

      /* Frontmatter Editor Styles */
      .frontmatter-container {
        padding: 12px;
      }

      .frontmatter-editor {
        min-height: 120px;
        max-height: 250px;
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        background: var(--bg-primary);
        margin-bottom: 8px;
        overflow-y: auto;
      }

      .frontmatter-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .btn {
        padding: 8px 12px;
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        background: var(--button-bg);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s;
      }

      .btn:hover {
        background: var(--button-hover);
      }

      .btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .btn-primary:hover {
        background: #0056b3;
        border-color: #0056b3;
      }

      .btn-secondary {
        background: var(--button-bg);
        color: var(--text-primary);
        border-color: var(--border-primary);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 11px;
      }

      .frontmatter-error {
        background: var(--error-color);
        color: white;
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        margin-top: 8px;
      }

      /* JSON Editor specific styling */
      .frontmatter-editor .je-object__container {
        background: transparent !important;
        border: none !important;
      }

      .frontmatter-editor .je-object__title {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-bottom: 1px solid var(--border-primary) !important;
      }

      .frontmatter-editor .form-control {
        background: var(--input-bg) !important;
        border: 1px solid var(--input-border) !important;
        color: var(--input-text) !important;
        font-size: var(--font-size-xs) !important;
      }

      .frontmatter-editor .form-control:focus {
        border-color: var(--input-border-focus) !important;
        box-shadow: 0 0 0 2px var(--focus-ring) !important;
      }

      .frontmatter-editor .btn {
        background: var(--button-secondary-bg) !important;
        border: 1px solid var(--border-primary) !important;
        color: var(--button-secondary-text) !important;
        font-size: var(--font-size-xs) !important;
      }

      .frontmatter-editor .btn:hover {
        background: var(--button-secondary-hover) !important;
      }

      .frontmatter-editor .je-object__controls {
        background: var(--bg-tertiary) !important;
      }

      /* Website Configuration Form Styling */
      #website-form-container {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }

      #website-form-container .je-object {
        margin-bottom: 20px;
      }

      #website-form-container .je-object__title {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        font-size: 16px;
        padding: 12px 16px;
        margin: 0 0 16px 0;
        border-radius: 4px;
        border: 1px solid var(--border-primary);
      }

      #website-form-container .je-child-editor-holder {
        padding: 0 16px 16px 16px;
      }

      #website-form-container .form-control {
        background: var(--bg-primary);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }

      #website-form-container .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        outline: none;
      }

      #website-form-container .je-form-input-label {
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 4px;
        display: block;
        font-size: 14px;
      }

      #website-form-container .je-description {
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 4px;
        font-style: italic;
      }

      #website-form-container .je-object__container {
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        margin-bottom: 16px;
        background: var(--bg-primary);
      }

      /* React JSON Schema Form Styling */
      #website-form-container .rjsf {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }

      #website-form-container .form-group {
        margin-bottom: 20px;
      }

      #website-form-container .form-group label {
        display: block;
        margin-bottom: 6px;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 14px;
      }

      #website-form-container .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 14px;
        box-sizing: border-box;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }

      #website-form-container .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        outline: none;
      }

      #website-form-container .help-block {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-secondary);
        font-style: italic;
        line-height: 1.4;
      }

      #website-form-container .panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        margin-bottom: 20px;
      }

      #website-form-container .panel-heading {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        font-size: 16px;
        padding: 12px 16px;
        margin: 0;
        border-bottom: 1px solid var(--border-primary);
        border-radius: 8px 8px 0 0;
      }

      #website-form-container .panel-body {
        padding: 20px;
      }

      #website-form-container .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition:
          background-color 0.2s ease,
          transform 0.1s ease;
        text-decoration: none;
        display: inline-block;
      }

      #website-form-container .btn-primary {
        background: #007bff;
        color: white;
      }

      #website-form-container .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      #website-form-container .btn-secondary {
        background: var(--button-secondary-bg);
        color: var(--button-secondary-text);
        border: 1px solid var(--border-primary);
      }

      #website-form-container .btn-secondary:hover {
        background: var(--button-secondary-hover);
      }

      /* Error styling */
      #website-form-container .has-error .form-control {
        border-color: #dc3545;
      }

      #website-form-container .has-error .help-block {
        color: #dc3545;
        font-weight: 500;
      }

      /* Required field indicator */
      #website-form-container .required:after {
        content: ' *';
        color: #dc3545;
        font-weight: bold;
      }

      /* Collapsible sections */
      #website-form-container .panel-title {
        font-size: 16px;
        margin: 0;
      }

      #website-form-container .panel-title a {
        color: var(--text-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #website-form-container .panel-title a:hover {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <!-- Skip navigation link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="main-container" role="application" aria-label="Website Editor">
      <aside class="left-panel" role="navigation" aria-label="File Explorer">
        <h2 class="sr-only">Project Files</h2>
        <!-- Files will be populated dynamically by JavaScript -->
      </aside>

      <div class="content-with-toolbar">
        <header class="toolbar" role="toolbar" aria-label="Editor Toolbar">
          <button class="toolbar-button" aria-label="Create new file" title="Create new file">
            <svg
              class="lucide lucide-file-plus"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
              <path d="M14,2 14,8 20,8" />
              <line x1="12" x2="12" y1="18" y2="12" />
              <line x1="9" x2="15" y1="15" y2="15" />
            </svg>
            New
          </button>
          <button class="toolbar-button" id="save-button" aria-label="Save current file" title="Save current file">
            <svg
              class="lucide lucide-save"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path
                d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
              />
              <path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7" />
              <path d="M7 3v4a1 1 0 0 0 1 1h8" />
            </svg>
            Save
          </button>
          <div class="toolbar-separator"></div>
          <button class="toolbar-button" aria-label="Format text as bold" title="Format text as bold">
            <svg
              class="lucide lucide-bold"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8" />
            </svg>
            Bold
          </button>
          <button class="toolbar-button" aria-label="Format text as italic" title="Format text as italic">
            <svg
              class="lucide lucide-italic"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <line x1="19" x2="10" y1="4" y2="4" />
              <line x1="14" x2="5" y1="20" y2="20" />
              <line x1="15" x2="9" y1="4" y2="20" />
            </svg>
            Italic
          </button>
          <button class="toolbar-button" aria-label="Insert link" title="Insert link">
            <svg
              class="lucide lucide-link"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
            </svg>
            Link
          </button>
          <div class="toolbar-separator"></div>
          <button
            class="toolbar-button"
            id="preview-edit-toggle"
            aria-label="Toggle between preview and edit mode"
            title="Toggle between preview and edit mode"
          >
            <svg
              class="lucide lucide-edit"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
              <path d="m15 5 4 4" />
            </svg>
            Edit
          </button>
        </header>

        <div class="center-right-container">
          <main class="center-panel" id="main-content" aria-label="Content Editor">
            <div class="center-content">
              <!-- Preview will be rendered by WebContentsView -->
              <div
                id="preview-placeholder"
                class="preview-placeholder"
                role="region"
                aria-label="Website Preview"
                aria-live="polite"
              >
                <p>Loading website preview...</p>
              </div>
              <!-- Ace Editor for edit mode -->
              <div
                id="ace-editor"
                class="ace-editor"
                role="textbox"
                aria-label="Code Editor"
                aria-multiline="true"
              ></div>
              <textarea
                id="editor-area"
                class="editor-area"
                aria-label="Markdown Editor"
                placeholder="ERROR: this should never display"
                style="display: none"
              ></textarea>
            </div>
          </main>

          <aside class="right-panel" role="complementary" aria-label="File Properties">
            <!-- Frontmatter Editor Section -->
            <section class="panel-section">
              <h3 class="panel-section-title">Frontmatter</h3>
              <div class="frontmatter-container">
                <div id="frontmatter-editor" class="frontmatter-editor" aria-label="Frontmatter Editor"></div>
                <div class="frontmatter-actions">
                  <button id="apply-frontmatter" class="btn btn-primary btn-sm" title="Apply frontmatter changes">
                    Apply Changes
                  </button>
                  <button id="reset-frontmatter" class="btn btn-secondary btn-sm" title="Reset frontmatter to original">
                    Reset
                  </button>
                </div>
                <div id="frontmatter-error" class="frontmatter-error" style="display: none" role="alert"></div>
              </div>
            </section>

            <!-- File Properties Section -->
            <section class="panel-section">
              <h3 class="panel-section-title">File Properties</h3>
              <div class="panel-content">
                <dl class="property-list">
                  <div class="property-item">
                    <dt class="property-label">File Type</dt>
                    <dd class="property-value" id="file-type">-</dd>
                  </div>
                  <div class="property-item">
                    <dt class="property-label">Word Count</dt>
                    <dd class="property-value" id="word-count">-</dd>
                  </div>
                  <div class="property-item">
                    <dt class="property-label">Last Modified</dt>
                    <dd class="property-value" id="last-modified">-</dd>
                  </div>
                  <div class="property-item">
                    <dt class="property-label">File Path</dt>
                    <dd class="property-value" id="file-path">-</dd>
                  </div>
                </dl>
              </div>
            </section>
          </aside>
        </div>
      </div>
    </div>

    <!-- Load required libraries from local node_modules -->
    <script src="../../../node_modules/js-yaml/dist/js-yaml.min.js"></script>

    <!-- Removed external React dependencies - using local HTML forms instead -->

    <script>
      // Initialize libraries after they load
      let yaml = window.jsyaml;

      // Fallback if libraries haven't loaded yet
      window.addEventListener('load', () => {
        if (!yaml) yaml = window.jsyaml;
        console.log('Libraries loaded - yaml:', !!yaml);
      });

      // Global variables
      let currentWebsite = null;
      let aceEditor = null;
      let isPreviewMode = true;
      let currentFileContent = '';
      let currentFilePath = null;
      let websiteFiles = [];
      let frontmatterEditor = null;
      let originalFrontmatter = null;

      // Initialize simplified website editor when the page loads
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize Lucide icons
        // Static icons - no JavaScript needed

        setupSimplePreviewToggle();
        setupSaveButton();
        setupFrontmatterEditor();
      });

      // Setup save button
      function setupSaveButton() {
        const saveButton = document.getElementById('save-button');
        if (saveButton) {
          saveButton.addEventListener('click', saveFileContent);
        }
      }

      // Simple preview toggle function
      function setupSimplePreviewToggle() {
        const toggleButton = document.getElementById('preview-edit-toggle');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const aceEditorDiv = document.getElementById('ace-editor');

        if (!toggleButton || !previewPlaceholder || !aceEditorDiv) {
          return;
        }

        // Start in preview mode
        previewPlaceholder.style.display = 'flex';
        aceEditorDiv.style.display = 'none';
        toggleButton.innerHTML =
          '<svg class="lucide lucide-edit" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg> Edit';

        // Initialize the icon
        // Static icons - no JavaScript needed

        toggleButton.addEventListener('click', function () {
          if (isPreviewMode) {
            // Switch to edit mode
            previewPlaceholder.style.display = 'none';
            aceEditorDiv.style.display = 'block';

            // Create simple editor if it doesn't exist
            let simpleEditor = document.getElementById('simple-editor');
            if (!simpleEditor) {
              aceEditorDiv.innerHTML =
                "<textarea id=\"simple-editor\" style=\"width: 100%; height: 100%; border: none; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; padding: 15px; resize: none; font-size: 14px; line-height: 1.5; background: var(--bg-primary); color: var(--text-primary); outline: none; box-sizing: border-box;\"></textarea>";
              simpleEditor = document.getElementById('simple-editor');
            }

            // Load current file content or default content
            if (currentFileContent) {
              simpleEditor.value = currentFileContent;
            } else {
              simpleEditor.value =
                "# Welcome to Your Website\n\nThis is your website's content. You can edit it here!\n\n## Getting Started\n\n- Edit this markdown content\n- Save your changes\n- Switch back to preview to see the result\n\n**Tip:** Use markdown syntax for formatting!";
            }
            toggleButton.innerHTML =
              '<svg class="lucide lucide-eye" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg> Preview';

            // Re-initialize icons after changing
            // Static icons - no JavaScript needed
            isPreviewMode = false;

            // Focus the editor after switching to edit mode
            setTimeout(() => {
              const editor = document.getElementById('simple-editor');
              if (editor) {
                editor.focus();
              }
            }, 100);

            // Hide the WebContentsView (website preview)
            if (window.electronAPI) {
              window.electronAPI.send('website-editor-show-edit');
            }
          } else {
            // Switch to preview mode
            aceEditorDiv.style.display = 'none';
            previewPlaceholder.style.display = 'flex';
            toggleButton.innerHTML =
              '<svg class="lucide lucide-edit" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg> Edit';

            // Re-initialize icons after changing
            // Static icons - no JavaScript needed
            isPreviewMode = true;

            // Show the WebContentsView (website preview)
            if (window.electronAPI) {
              window.electronAPI.send('website-editor-show-preview');
            }
          }
        });
      }

      // Initialize Ace Editor
      function initializeAceEditor() {
        aceEditor = ace.edit('ace-editor');
        aceEditor.setTheme('ace/theme/monokai');
        aceEditor.session.setMode('ace/mode/markdown');
        aceEditor.setOptions({
          fontFamily: 'Monaco, Menlo, monospace',
          fontSize: 14,
          wrap: true,
          showPrintMargin: false,
          enableBasicAutocompletion: true,
          enableLiveAutocompletion: true,
        });

        // Set default content
        aceEditor.setValue(
          `# Welcome to your website

This is a **bold** statement and this is *italic* text.

You can create:
- Lists
- Links
- Images
- And much more!

[Learn more about Markdown](https://www.markdownguide.org/)`,
          -1
        );

        currentFileContent = aceEditor.getValue();
      }

      // Function to get appropriate icon for file type
      function getFileIcon(fileName, isDirectory) {
        const folderIcon =
          '<svg class="lucide lucide-folder" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" /></svg>';
        const fileTextIcon =
          '<svg class="lucide lucide-file-text" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14,2 14,8 20,8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>';
        const codeIcon =
          '<svg class="lucide lucide-code" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/></svg>';
        const settingsIcon =
          '<svg class="lucide lucide-settings" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>';
        const imageIcon =
          '<svg class="lucide lucide-image" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>';
        const fileIcon =
          '<svg class="lucide lucide-file" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14,2 14,8 20,8"/></svg>';

        if (isDirectory) {
          return folderIcon;
        }

        const ext = fileName.split('.').pop().toLowerCase();
        switch (ext) {
          case 'md':
          case 'markdown':
            return fileTextIcon;
          case 'html':
          case 'htm':
          case 'css':
          case 'js':
          case 'ts':
            return codeIcon;
          case 'json':
          case 'yml':
          case 'yaml':
            return settingsIcon;
          case 'png':
          case 'jpg':
          case 'jpeg':
          case 'gif':
          case 'svg':
            return imageIcon;
          default:
            return fileIcon;
        }
      }

      // Helper function to read anglesite.json configuration
      async function getAnglesiteConfig(websitePath) {
        try {
          const websiteName = currentWebsite?.name;
          if (!websiteName) {
            return null;
          }

          const configContent = await window.electronAPI.invoke(
            'get-file-content',
            websiteName,
            '_data/anglesite.json'
          );
          if (configContent) {
            return JSON.parse(configContent);
          }
        } catch (error) {}
        return null;
      }

      // Helper function to build hierarchical file tree structure
      async function buildFileTree(files, websitePath) {
        const tree = [];

        // Get configuration to check for WYSIWYG mode
        const config = await getAnglesiteConfig(websitePath);
        const isWysiwygMode = config && config.edit_mode === 'WYSIWYG';

        files.forEach((file) => {
          // Convert backend FileUrlMapping format to frontend expected format
          const relativePath = file.filePath.replace(websitePath + '/src/', '');
          const pathParts = relativePath.split('/');

          // In WYSIWYG mode, hide _data, _includes, and _layouts directories
          if (isWysiwygMode && pathParts.length >= 1) {
            const rootDir = pathParts[0];
            if (rootDir === '_data' || rootDir === '_includes' || rootDir === '_layouts') {
              return; // Skip this file/directory
            }
          }

          if (pathParts.length === 1) {
            // Root level file or directory - convert to expected format
            tree.push({
              name: pathParts[0],
              type: file.isDirectory ? 'directory' : 'file',
              path: file.filePath,
              filePath: file.filePath,
              isDirectory: file.isDirectory,
              url: file.url,
              children: [],
            });
          }
        });

        // Add children to directories
        files.forEach((file) => {
          const relativePath = file.filePath.replace(websitePath + '/src/', '');
          const pathParts = relativePath.split('/');

          // In WYSIWYG mode, skip files in hidden directories
          if (isWysiwygMode && pathParts.length >= 1) {
            const rootDir = pathParts[0];
            if (rootDir === '_data' || rootDir === '_includes' || rootDir === '_layouts') {
              return; // Skip this file/directory
            }
          }

          if (pathParts.length > 1) {
            // This is a nested file - find its parent directory
            const parentDirName = pathParts[0];
            const parentDir = tree.find((item) => item.name === parentDirName && item.isDirectory);

            if (parentDir) {
              parentDir.children.push({
                name: pathParts[pathParts.length - 1],
                type: file.isDirectory ? 'directory' : 'file',
                path: file.filePath,
                filePath: file.filePath,
                isDirectory: file.isDirectory,
                url: file.url,
                children: [],
              });
            }
          }
        });

        // Sort tree: directories first, then alphabetically
        tree.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
        });

        // Sort children in each directory
        tree.forEach((item) => {
          if (item.children) {
            item.children.sort((a, b) => {
              if (a.isDirectory && !b.isDirectory) return -1;
              if (!a.isDirectory && b.isDirectory) return 1;
              return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });
          }
        });

        return tree;
      }

      // Helper function to render file tree as nested ul/li
      function renderFileTree(tree, parentElement) {
        tree.forEach((item) => {
          const listItem = document.createElement('li');
          listItem.className = 'file-item';
          listItem.setAttribute('role', 'treeitem');
          listItem.setAttribute('aria-label', `${item.isDirectory ? 'Folder' : 'File'}: ${item.name}`);

          // Create content with disclosure triangle for directories
          const hasChildren = item.isDirectory && item.children && item.children.length > 0;
          const isCollapsedByDefault = false; // Set to true if you want folders collapsed by default
          const triangleClass = isCollapsedByDefault ? 'disclosure-triangle collapsed' : 'disclosure-triangle';

          if (hasChildren) {
            listItem.setAttribute('aria-expanded', isCollapsedByDefault ? 'false' : 'true');
            listItem.setAttribute('aria-haspopup', 'true');
          }

          const disclosureTriangle = hasChildren
            ? `<span class="${triangleClass}" aria-hidden="true">▶</span>`
            : '<span style="width: 12px; display: inline-block;" aria-hidden="true"></span>';

          // Add collapsed class to list item if starting collapsed
          if (hasChildren && isCollapsedByDefault) {
            listItem.classList.add('collapsed');
          }

          listItem.innerHTML = `
            <div class="file-item-content ${item.isDirectory ? 'directory' : ''}" tabindex="0" role="button">
              ${disclosureTriangle}
              ${getFileIcon(item.name, item.isDirectory)}
              ${item.name}
            </div>
          `;

          const contentDiv = listItem.querySelector('.file-item-content');

          if (item.isDirectory && hasChildren) {
            // Add click handler for directories to toggle expand/collapse
            contentDiv.addEventListener('click', () => {
              const triangle = listItem.querySelector('.disclosure-triangle');
              const isCollapsed = listItem.classList.contains('collapsed');

              if (isCollapsed) {
                // Expand
                listItem.classList.remove('collapsed');
                triangle.classList.remove('collapsed');
                listItem.setAttribute('aria-expanded', 'true');
              } else {
                // Collapse
                listItem.classList.add('collapsed');
                triangle.classList.add('collapsed');
                listItem.setAttribute('aria-expanded', 'false');
              }
            });
          } else if (!item.isDirectory) {
            // Add click handler for files
            contentDiv.addEventListener('click', async () => {
              // Add visual feedback for selected file
              document.querySelectorAll('.file-item').forEach((fileItem) => {
                fileItem.classList.remove('selected');
                fileItem.setAttribute('aria-selected', 'false');
              });
              listItem.classList.add('selected');
              listItem.setAttribute('aria-selected', 'true');

              // Load file content for editing
              await loadFileContent(item.filePath);

              // Update preview to show this specific file
              await updatePreviewForFile(item.filePath);
            });
          }

          parentElement.appendChild(listItem);

          // If this is a directory with children, create nested ul
          if (item.isDirectory && item.children && item.children.length > 0) {
            const nestedList = document.createElement('ul');
            nestedList.className = 'file-list';
            nestedList.setAttribute('role', 'group');
            nestedList.setAttribute('aria-label', `Contents of ${item.name}`);
            renderFileTree(item.children, nestedList);
            listItem.appendChild(nestedList);
          }
        });
      }

      // Function to update preview pane for a specific file
      async function updatePreviewForFile(filePath) {
        try {
          // Get the URL for this file from the URL resolver
          const fileUrl = await window.electronAPI.invoke('get-file-url', currentWebsite.name, filePath);

          if (fileUrl) {
            // Get the base server URL and construct full URL
            const websiteServer = await window.electronAPI.invoke('get-website-server-url', currentWebsite.name);

            if (websiteServer) {
              const fullUrl = websiteServer + fileUrl;

              // Update the preview placeholder to show loading
              const placeholder = document.getElementById('preview-placeholder');
              if (placeholder) {
                placeholder.innerHTML = `<p>Loading preview for ${filePath.split('/').pop()}...</p>`;
              }

              // Load the specific file URL in the preview
              // Note: This would need to be sent to the main process to update the WebContentsView
              window.electronAPI.send('load-file-preview', currentWebsite.name, fullUrl);
            }
          } else {
            // Show message for non-previewable files
            const placeholder = document.getElementById('preview-placeholder');
            if (placeholder) {
              placeholder.innerHTML = `<p>Preview not available for ${filePath.split('/').pop()}</p>`;
            }
          }
        } catch (error) {
          console.error(`Error updating preview for file: ${filePath}`, error);

          const placeholder = document.getElementById('preview-placeholder');
          if (placeholder) {
            placeholder.innerHTML = `<p>Error loading preview for ${filePath.split('/').pop()}</p>`;
          }
        }
      }

      // Function to load file content for editing
      async function loadFileContent(filePath) {
        try {
          // Convert absolute path to relative path for context-aware API
          const websiteName = currentWebsite?.name;
          if (!websiteName) {
            console.error('[DEBUG] No website name available for loading file');
            return;
          }

          // Convert absolute path to relative path by removing the website src directory
          const websiteServer = currentWebsite.path;
          const srcPath = websiteServer + '/src/';
          let relativePath = filePath;

          if (filePath.startsWith(srcPath)) {
            relativePath = filePath.substring(srcPath.length);
          } else if (filePath.startsWith(websiteServer + '/')) {
            relativePath = filePath.substring((websiteServer + '/').length);
          }

          console.log(`[DEBUG] Loading file: website=${websiteName}, relativePath=${relativePath}`);

          // Get file content from main process using context-aware API
          const content = await window.electronAPI.invoke('get-file-content', websiteName, relativePath);

          if (content !== null) {
            currentFilePath = filePath;
            currentFileContent = content;

            // Update editor with file content
            if (aceEditor) {
              aceEditor.setValue(content, -1);
            } else {
              // Update simple editor if ace not loaded
              const simpleEditor = document.getElementById('simple-editor');
              if (simpleEditor) {
                simpleEditor.value = content;
              } else {
              }
            }

            // Update properties panel
            updatePropertiesPanel(filePath, content);
          } else {
            console.error('[DEBUG] Failed to load file content - content is null');
          }
        } catch (error) {
          console.error('[DEBUG] Error loading file content:', error);
        }
      }

      // Function to save file content
      async function saveFileContent() {
        if (!currentFilePath) {
          console.warn('No file selected for saving');
          return;
        }

        try {
          let content;
          if (aceEditor) {
            content = aceEditor.getValue();
          } else {
            const simpleEditor = document.getElementById('simple-editor');
            content = simpleEditor ? simpleEditor.value : currentFileContent;
          }

          // Convert absolute path to relative path for context-aware API
          const websiteName = currentWebsite?.name;
          if (!websiteName) {
            console.error('[DEBUG] No website name available for saving file');
            return;
          }

          // Convert absolute path to relative path by removing the website src directory
          const websiteServer = currentWebsite.path;
          const srcPath = websiteServer + '/src/';
          let relativePath = currentFilePath;

          if (currentFilePath.startsWith(srcPath)) {
            relativePath = currentFilePath.substring(srcPath.length);
          } else if (currentFilePath.startsWith(websiteServer + '/')) {
            relativePath = currentFilePath.substring((websiteServer + '/').length);
          }

          console.log(`[DEBUG] Saving file: website=${websiteName}, relativePath=${relativePath}`);

          const success = await window.electronAPI.invoke('save-file-content', websiteName, relativePath, content);

          if (success) {
            currentFileContent = content;
            console.log('File saved successfully');
            // Update properties panel to reflect save
            updatePropertiesPanel(currentFilePath, content);
          } else {
            console.error('Failed to save file');
          }
        } catch (error) {
          console.error('Error saving file:', error);
        }
      }

      // Global website editor
      let websiteEditor = null;

      // Function to show website configuration editor
      async function showBlankEditor() {
        // Set current file to website.json
        currentFilePath = 'src/_data/website.json';

        // Switch to edit mode
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const aceEditorDiv = document.getElementById('ace-editor');
        const toggleButton = document.getElementById('preview-edit-toggle');

        if (previewPlaceholder && aceEditorDiv && toggleButton) {
          // Hide preview, show editor
          previewPlaceholder.style.display = 'none';
          aceEditorDiv.style.display = 'block';

          // Create website configuration form container
          aceEditorDiv.innerHTML = `
            <div id="website-config-editor" style="width: 100%; height: 100%; overflow-y: auto; padding: 20px; background: var(--bg-primary);">
              <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">Website Configuration</h3>
                <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">Configure your website settings, metadata, and features.</p>
              </div>
              <div id="website-form-container" style="background: var(--bg-secondary); border-radius: 8px; padding: 20px; border: 1px solid var(--border-primary);"></div>
              <div style="margin-top: 20px; display: flex; gap: 12px;">
                <button id="save-website-config" class="btn btn-primary" style="padding: 10px 20px; font-size: 14px;">
                  Save Configuration
                </button>
                <button id="reset-website-config" class="btn btn-secondary" style="padding: 10px 20px; font-size: 14px;">
                  Reset Changes
                </button>
              </div>
              <div id="website-config-error" class="frontmatter-error" style="display: none; margin-top: 12px;" role="alert"></div>
            </div>
          `;

          // Initialize the website configuration editor
          await initializeWebsiteConfigEditor();

          // Update toggle button to show it's in edit mode
          toggleButton.innerHTML =
            '<svg class="lucide lucide-eye" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg> Preview';

          isPreviewMode = false;

          // Hide the WebContentsView (website preview)
          if (window.electronAPI) {
            window.electronAPI.send('website-editor-show-edit');
          }
        }

        // Update properties panel for website.json
        updatePropertiesPanel(currentFilePath, JSON.stringify({}, null, 2));

        // Clear frontmatter editor (not applicable for website config)
        if (frontmatterEditor) {
          frontmatterEditor.setValue({});
        }
      }

      // Simple initialization without complex retry logic

      // Load the website schema from the anglesite-11ty package
      async function loadWebsiteSchema() {
        try {
          // Try to load the schema file directly
          const response = await fetch('../../anglesite-11ty/schemas/website.schema.json');
          if (response.ok) {
            return await response.json();
          }
        } catch (error) {
          console.log('Could not load schema file directly, using embedded schema');
        }

        // Fallback to embedded schema (essential fields from the original)
        return {
          $schema: 'http://json-schema.org/draft-07/schema#',
          title: 'Website Configuration',
          description: 'Configure your website settings, metadata, and features',
          type: 'object',
          required: ['title', 'language'],
          properties: {
            title: {
              type: 'string',
              title: 'Website Title',
              description: 'The main title of your website that appears in the browser tab and search results',
              minLength: 1,
              examples: ['My Awesome Website', 'Anglesite Starter'],
            },
            language: {
              type: 'string',
              title: 'Primary Language',
              description: 'The primary language of your website using ISO 639-1 language codes',
              pattern: '^[a-z]{2}(-[A-Z]{2})?$',
              examples: ['en', 'en-US', 'fr', 'de', 'es'],
            },
            description: {
              type: 'string',
              title: 'Website Description',
              description: 'A brief description of your website used for SEO and social media previews',
              maxLength: 160,
            },
            url: {
              type: 'string',
              title: 'Website URL',
              description: 'The base URL where your website will be hosted (must use HTTPS)',
              format: 'uri',
              pattern: '^https://',
              examples: ['https://example.com', 'https://mysite.netlify.app'],
            },
            author: {
              type: 'object',
              title: 'Author Information',
              description: 'Information about the website author or organization',
              properties: {
                name: {
                  type: 'string',
                  title: 'Name',
                  description: 'Your full name or organization name',
                },
                email: {
                  type: 'string',
                  title: 'Email Address',
                  format: 'email',
                  description: 'Contact email address for the website',
                },
                url: {
                  type: 'string',
                  title: 'Personal Website',
                  format: 'uri',
                  description: 'Your personal website or company homepage',
                },
              },
            },
            social: {
              type: 'object',
              title: 'Social Media Profiles',
              description: 'Your social media accounts for integration and sharing',
              properties: {
                twitter: {
                  type: 'string',
                  title: 'Twitter/X Username',
                  description: 'Your Twitter/X username (without the @ symbol)',
                  pattern: '^[A-Za-z0-9_]+$',
                },
                github: {
                  type: 'string',
                  title: 'GitHub Username',
                  description: 'Your GitHub username or organization',
                },
                linkedin: {
                  type: 'string',
                  title: 'LinkedIn Profile',
                  description: 'Full URL to your LinkedIn profile or company page',
                },
              },
            },
            analytics: {
              type: 'object',
              title: 'Analytics & Tracking',
              description: 'Configure website analytics and tracking services',
              properties: {
                google: {
                  type: 'string',
                  title: 'Google Analytics ID',
                  description: 'Your Google Analytics measurement ID (starts with G-, UA-, or GTM-)',
                  pattern: '^(UA-|G-|GTM-)',
                  examples: ['G-XXXXXXXXXX', 'UA-XXXXX-Y'],
                },
              },
            },
            manifest: {
              type: 'object',
              title: 'Progressive Web App',
              description: 'Settings for Progressive Web App features',
              properties: {
                theme_color: {
                  type: 'string',
                  title: 'Theme Color',
                  description: 'Primary theme color for your app (hex color code)',
                  pattern: '^#[0-9A-Fa-f]{6}$',
                  examples: ['#007bff', '#28a745', '#dc3545'],
                },
                background_color: {
                  type: 'string',
                  title: 'Background Color',
                  description: 'Background color for the splash screen (hex color code)',
                  pattern: '^#[0-9A-Fa-f]{6}$',
                  examples: ['#ffffff', '#f8f9fa'],
                },
              },
            },
          },
        };
      }

      // Initialize website configuration editor
      async function initializeWebsiteConfigEditor() {
        console.log('Initializing website configuration editor');

        try {
          // Get website name
          const websiteName = currentWebsite?.name;
          if (!websiteName) {
            throw new Error('No website loaded');
          }

          // Load existing website.json data
          let formData = {};
          try {
            const existingContent = await window.electronAPI.invoke(
              'get-file-content',
              websiteName,
              'src/_data/website.json'
            );
            if (existingContent) {
              formData = JSON.parse(existingContent);
              currentFileContent = existingContent;
            }
          } catch (error) {
            console.log('No existing website.json found, starting with defaults');
            // Set some sensible defaults
            formData = {
              title: websiteName || 'My Website',
              language: 'en',
            };
            currentFileContent = JSON.stringify(formData, null, 2);
          }

          // Get the form container
          const container = document.getElementById('website-form-container');
          if (!container) {
            throw new Error('Form container not found');
          }

          // Create the website configuration form
          createWebsiteConfigForm(container, formData);
          setupWebsiteFormHandlers();

          console.log('Website configuration editor initialized successfully');
        } catch (error) {
          console.error('Failed to initialize website configuration editor:', error);
          showWebsiteConfigError(`Failed to load website configuration: ${error.message}`);
        }
      }

      // Save website configuration
      async function saveWebsiteConfiguration() {
        if (!websiteEditor || !currentWebsite) {
          return;
        }

        try {
          // Validate the form
          const errors = websiteEditor.validate();
          if (errors.length > 0) {
            showWebsiteConfigError(
              `Please fix the following errors:\n${errors.map((e) => `• ${e.path}: ${e.message}`).join('\n')}`
            );
            return;
          }

          // Get the form data
          const websiteData = websiteEditor.getValue();
          const websiteJson = JSON.stringify(websiteData, null, 2);

          // Save to file
          const success = await window.electronAPI.invoke(
            'save-file-content',
            currentWebsite.name,
            'src/_data/website.json',
            websiteJson
          );

          if (success) {
            currentFileContent = websiteJson;
            hideWebsiteConfigError();
            console.log('Website configuration saved successfully');

            // Update properties panel
            updatePropertiesPanel(currentFilePath, websiteJson);

            // Show success feedback
            const saveButton = document.getElementById('save-website-config');
            if (saveButton) {
              const originalText = saveButton.textContent;
              saveButton.textContent = 'Saved!';
              saveButton.style.background = '#28a745';
              setTimeout(() => {
                saveButton.textContent = originalText;
                saveButton.style.background = '';
              }, 2000);
            }
          } else {
            throw new Error('Failed to save file');
          }
        } catch (error) {
          console.error('Error saving website configuration:', error);
          showWebsiteConfigError(`Failed to save configuration: ${error.message}`);
        }
      }

      // Reset website configuration
      function resetWebsiteConfiguration() {
        if (!websiteEditor) {
          return;
        }

        try {
          // Parse the original content and reset the form
          const originalData = currentFileContent ? JSON.parse(currentFileContent) : {};
          websiteEditor.setValue(originalData);
          hideWebsiteConfigError();
        } catch (error) {
          console.error('Failed to reset website configuration:', error);
          showWebsiteConfigError('Failed to reset configuration');
        }
      }

      // Show website configuration error
      function showWebsiteConfigError(message) {
        const errorEl = document.getElementById('website-config-error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }

      // Hide website configuration error
      function hideWebsiteConfigError() {
        const errorEl = document.getElementById('website-config-error');
        if (errorEl) {
          errorEl.style.display = 'none';
        }
      }

      // Create React JSON Schema Form
      function createRJSFForm(container, schema, formData) {
        console.log('Creating RJSF form with schema:', schema.title);

        // Clear container
        container.innerHTML = '';

        // Create React component
        const formElement = React.createElement(window.JSONSchemaFormCore.default, {
          schema: schema,
          formData: formData,
          validator: window.RJSFValidatorAjv8.default,
          onChange: (e) => {
            console.log('Form data changed:', e.formData);
            // Hide error on change
            hideWebsiteConfigError();
          },
          onSubmit: (e) => {
            console.log('Form submitted:', e.formData);
            saveFormData(e.formData);
          },
          onError: (errors) => {
            console.log('Form errors:', errors);
            showWebsiteConfigError(
              `Please fix the following errors:\n${errors.map((e) => `• ${e.property}: ${e.message}`).join('\n')}`
            );
          },
          uiSchema: {
            'ui:submitButtonOptions': {
              submitText: 'Save Configuration',
              norender: false,
              props: {
                className: 'btn btn-primary',
              },
            },
            'ui:globalOptions': {
              addable: true,
              orderable: false,
              removable: true,
            },
            // Enhance form fields with better descriptions and help text
            title: {
              'ui:description': 'This title appears in browser tabs and search results',
            },
            description: {
              'ui:widget': 'textarea',
              'ui:options': {
                rows: 3,
              },
              'ui:description': 'Keep under 160 characters for optimal SEO',
            },
            author: {
              'ui:description': 'Information about you or your organization',
            },
            social: {
              'ui:description': 'Connect your social media profiles for better integration',
            },
            analytics: {
              'ui:description': "Track your website's performance and visitor behavior",
            },
            manifest: {
              'ui:description': 'Configure Progressive Web App features for mobile users',
            },
          },
        });

        // Render the form
        const root = ReactDOM.createRoot(container);
        root.render(formElement);

        // Store the form data globally for the save/reset functions
        websiteEditor = {
          getValue: () => formData,
          setValue: (data) => {
            formData = data;
            // Re-render with new data
            const updatedElement = React.createElement(window.JSONSchemaFormCore.default, {
              schema: schema,
              formData: data,
              validator: window.RJSFValidatorAjv8.default,
              onChange: (e) => {
                formData = e.formData;
                hideWebsiteConfigError();
              },
              onSubmit: (e) => {
                console.log('Form submitted:', e.formData);
                saveFormData(e.formData);
              },
              onError: (errors) => {
                console.log('Form errors:', errors);
                showWebsiteConfigError(
                  `Please fix the following errors:\n${errors.map((e) => `• ${e.property}: ${e.message}`).join('\n')}`
                );
              },
            });
            root.render(updatedElement);
          },
          validate: () => {
            // RJSF handles validation internally
            return [];
          },
          destroy: () => {
            root.unmount();
          },
        };

        console.log('RJSF form created successfully');
      }

      // Save form data
      async function saveFormData(formData) {
        if (!currentWebsite) {
          showWebsiteConfigError('No website loaded');
          return;
        }

        try {
          const websiteJson = JSON.stringify(formData, null, 2);
          const success = await window.electronAPI.invoke(
            'save-file-content',
            currentWebsite.name,
            'src/_data/website.json',
            websiteJson
          );

          if (success) {
            currentFileContent = websiteJson;
            hideWebsiteConfigError();
            console.log('Website configuration saved successfully');

            // Update properties panel
            updatePropertiesPanel(currentFilePath, websiteJson);

            // Show success feedback
            showWebsiteConfigSuccess('Configuration saved successfully!');
          } else {
            throw new Error('Failed to save file');
          }
        } catch (error) {
          console.error('Error saving website configuration:', error);
          showWebsiteConfigError(`Failed to save configuration: ${error.message}`);
        }
      }

      // Show success message
      function showWebsiteConfigSuccess(message) {
        // You could implement a success notification here
        console.log('Success:', message);
      }

      // Legacy function for compatibility - now uses RJSF
      function createWebsiteConfigForm(container, websiteData) {
        console.log('Creating website configuration form with data:', websiteData);

        container.innerHTML = `
          <div class="website-config-form">
            <div class="form-group">
              <label for="website-title">Website Title *</label>
              <input type="text" id="website-title" class="form-control" value="${websiteData.title || ''}" required placeholder="My Awesome Website">
              <small class="form-text">The main title of your website</small>
            </div>
            
            <div class="form-group">
              <label for="website-language">Primary Language *</label>
              <input type="text" id="website-language" class="form-control" value="${websiteData.language || 'en'}" required placeholder="en">
              <small class="form-text">Language code (e.g., en, fr, de)</small>
            </div>
            
            <div class="form-group">
              <label for="website-description">Description</label>
              <textarea id="website-description" class="form-control" rows="3" maxlength="160" placeholder="A brief description of your website">${websiteData.description || ''}</textarea>
              <small class="form-text">Brief description for SEO (max 160 characters)</small>
            </div>
            
            <div class="form-group">
              <label for="website-url">Website URL</label>
              <input type="url" id="website-url" class="form-control" value="${websiteData.url || ''}" placeholder="https://example.com">
              <small class="form-text">The base URL where your website will be hosted</small>
            </div>
            
            <div class="form-section">
              <h4>Author Information</h4>
              <div class="form-group">
                <label for="author-name">Name</label>
                <input type="text" id="author-name" class="form-control" value="${websiteData.author?.name || ''}" placeholder="Your name">
              </div>
              <div class="form-group">
                <label for="author-email">Email</label>
                <input type="email" id="author-email" class="form-control" value="${websiteData.author?.email || ''}" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="author-url">Website/Profile URL</label>
                <input type="url" id="author-url" class="form-control" value="${websiteData.author?.url || ''}" placeholder="https://yourwebsite.com">
              </div>
            </div>
            
            <div class="form-section">
              <h4>Social Media</h4>
              <div class="form-group">
                <label for="social-twitter">Twitter/X Username</label>
                <input type="text" id="social-twitter" class="form-control" value="${websiteData.social?.twitter || ''}" placeholder="yourusername">
              </div>
              <div class="form-group">
                <label for="social-github">GitHub Username</label>
                <input type="text" id="social-github" class="form-control" value="${websiteData.social?.github || ''}" placeholder="yourusername">
              </div>
            </div>
            
            <div class="form-section">
              <h4>Analytics</h4>
              <div class="form-group">
                <label for="analytics-google">Google Analytics ID</label>
                <input type="text" id="analytics-google" class="form-control" value="${websiteData.analytics?.google || ''}" placeholder="G-XXXXXXXXXX">
              </div>
            </div>
          </div>
        `;

        // Add CSS for website config form
        if (!document.getElementById('website-config-form-styles')) {
          const style = document.createElement('style');
          style.id = 'website-config-form-styles';
          style.textContent = `
            .website-config-form .form-group {
              margin-bottom: 16px;
            }
            .website-config-form .form-section {
              margin-top: 24px;
              padding-top: 16px;
              border-top: 1px solid var(--border-primary);
            }
            .website-config-form .form-section h4 {
              margin: 0 0 16px 0;
              color: var(--text-primary);
              font-size: 16px;
              font-weight: 600;
            }
            .website-config-form label {
              display: block;
              margin-bottom: 4px;
              color: var(--text-primary);
              font-weight: 500;
              font-size: 14px;
            }
            .website-config-form .form-control {
              width: 100%;
              padding: 8px 12px;
              border: 1px solid var(--border-primary);
              border-radius: 4px;
              background: var(--bg-primary);
              color: var(--text-primary);
              font-size: 14px;
              box-sizing: border-box;
            }
            .website-config-form .form-control:focus {
              border-color: #007bff;
              box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
              outline: none;
            }
            .website-config-form .form-text {
              display: block;
              margin-top: 4px;
              font-size: 12px;
              color: var(--text-secondary);
              font-style: italic;
            }
          `;
          document.head.appendChild(style);
        }

        // Create a simple websiteEditor-like object for compatibility
        websiteEditor = {
          getValue: function () {
            return {
              title: document.getElementById('website-title')?.value || '',
              language: document.getElementById('website-language')?.value || 'en',
              description: document.getElementById('website-description')?.value || '',
              url: document.getElementById('website-url')?.value || '',
              author: {
                name: document.getElementById('author-name')?.value || '',
                email: document.getElementById('author-email')?.value || '',
                url: document.getElementById('author-url')?.value || '',
              },
              social: {
                twitter: document.getElementById('social-twitter')?.value || '',
                github: document.getElementById('social-github')?.value || '',
              },
              analytics: {
                google: document.getElementById('analytics-google')?.value || '',
              },
            };
          },
          setValue: function (data) {
            if (document.getElementById('website-title'))
              document.getElementById('website-title').value = data.title || '';
            if (document.getElementById('website-language'))
              document.getElementById('website-language').value = data.language || 'en';
            if (document.getElementById('website-description'))
              document.getElementById('website-description').value = data.description || '';
            if (document.getElementById('website-url')) document.getElementById('website-url').value = data.url || '';
            if (document.getElementById('author-name'))
              document.getElementById('author-name').value = data.author?.name || '';
            if (document.getElementById('author-email'))
              document.getElementById('author-email').value = data.author?.email || '';
            if (document.getElementById('author-url'))
              document.getElementById('author-url').value = data.author?.url || '';
            if (document.getElementById('social-twitter'))
              document.getElementById('social-twitter').value = data.social?.twitter || '';
            if (document.getElementById('social-github'))
              document.getElementById('social-github').value = data.social?.github || '';
            if (document.getElementById('analytics-google'))
              document.getElementById('analytics-google').value = data.analytics?.google || '';
          },
          validate: function () {
            const errors = [];
            const title = document.getElementById('website-title')?.value;
            const language = document.getElementById('website-language')?.value;

            if (!title) errors.push({ path: 'title', message: 'Title is required' });
            if (!language) errors.push({ path: 'language', message: 'Language is required' });

            return errors;
          },
          destroy: function () {
            // No-op for fallback
          },
          on: function (event, callback) {
            // Simple event handling for change events
            if (event === 'change') {
              const inputs = container.querySelectorAll('input, textarea');
              inputs.forEach((input) => {
                input.addEventListener('input', callback);
                input.addEventListener('change', callback);
              });
            }
          },
        };

        console.log('Website configuration form created successfully');
      }

      // Setup event handlers for website configuration form
      function setupWebsiteFormHandlers() {
        // Setup save button
        const saveButton = document.getElementById('save-website-config');
        if (saveButton) {
          saveButton.addEventListener('click', saveWebsiteConfiguration);
        }

        // Setup reset button
        const resetButton = document.getElementById('reset-website-config');
        if (resetButton) {
          resetButton.addEventListener('click', resetWebsiteConfiguration);
        }

        // Setup change event handler
        if (websiteEditor && websiteEditor.on) {
          websiteEditor.on('change', function () {
            hideWebsiteConfigError();
          });
        }
      }

      // Function to update properties panel
      function updatePropertiesPanel(filePath, content) {
        if (!filePath) {
          // Clear all properties when no file is selected
          const fileTypeEl = document.getElementById('file-type');
          const wordCountEl = document.getElementById('word-count');
          const lastModifiedEl = document.getElementById('last-modified');
          const filePathEl = document.getElementById('file-path');

          if (fileTypeEl) fileTypeEl.textContent = '-';
          if (wordCountEl) wordCountEl.textContent = '-';
          if (lastModifiedEl) lastModifiedEl.textContent = '-';
          if (filePathEl) filePathEl.textContent = '-';
          return;
        }

        const fileName = filePath.split('/').pop();
        const ext = fileName.split('.').pop().toLowerCase();

        // Update file type
        const fileTypeEl = document.querySelector('.property-item .property-value');
        if (fileTypeEl) {
          switch (ext) {
            case 'md':
              fileTypeEl.textContent = 'Markdown';
              break;
            case 'html':
              fileTypeEl.textContent = 'HTML';
              break;
            case 'css':
              fileTypeEl.textContent = 'CSS';
              break;
            case 'js':
              fileTypeEl.textContent = 'JavaScript';
              break;
            default:
              fileTypeEl.textContent = ext.toUpperCase();
          }
        }

        // Update word count for text files
        const wordCountEl = document.querySelectorAll('.property-item .property-value')[1];
        if (wordCountEl && content) {
          const wordCount = content.split(/\s+/).filter((word) => word.length > 0).length;
          wordCountEl.textContent = wordCount.toString();
        }

        // Update last modified
        const lastModifiedEl = document.querySelectorAll('.property-item .property-value')[2];
        if (lastModifiedEl) {
          lastModifiedEl.textContent = new Date().toLocaleString();
        }
      }

      // Function to populate file explorer - reads files directly from disk
      async function populateFileExplorer() {
        const fileExplorer = document.querySelector('.left-panel');

        try {
          // Show loading message
          fileExplorer.innerHTML =
            '<div style="padding: 16px; color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 8px;"><div style="width: 12px; height: 12px; border: 2px solid var(--text-secondary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>Loading project files...</div><style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>';

          // Get website name from window title or current website
          const websiteName = currentWebsite?.name || document.title || 'unknown';
          console.log('Loading files for website:', websiteName);

          // Request files directly from filesystem via IPC
          const files = await window.electronAPI.invoke('get-website-files', websiteName);
          console.log('Received files from backend:', files);
          console.log('First file structure:', files && files.length > 0 ? files[0] : 'No files');

          if (files && files.length > 0) {
            files.forEach((file, index) => {
              if (index < 5) {
                // Show first 5 files for debugging
                console.log(`  ${file.isDirectory ? '[DIR]' : '[FILE]'} ${file.filePath}`);
                console.log('    Full file object:', file);
              }
            });
          }

          websiteFiles = files;
          fileExplorer.innerHTML = '';

          // Check if files array is empty or null
          if (!files || files.length === 0) {
            throw new Error(`No files found for website: ${websiteName}`);
          }

          // Create virtual website entry at the top
          const virtualEntry = document.createElement('div');
          virtualEntry.className = 'file-item virtual-website-entry';
          virtualEntry.style.cssText =
            'padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid var(--border-secondary); background: var(--bg-tertiary);';
          virtualEntry.innerHTML = `
            <div class="file-item-content" tabindex="0" role="button" style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;" aria-hidden="true">🌐</span>
              <span style="font-weight: 500;">${websiteName}</span>
            </div>
          `;

          // Add click handler for virtual website entry
          virtualEntry.querySelector('.file-item-content').addEventListener('click', () => {
            // Remove selection from all file items
            document.querySelectorAll('.file-item').forEach((fileItem) => {
              fileItem.classList.remove('selected');
              fileItem.setAttribute('aria-selected', 'false');
            });
            // Select the virtual entry
            virtualEntry.classList.add('selected');
            virtualEntry.setAttribute('aria-selected', 'true');

            // Show blank editor in preview area
            showBlankEditor();
          });

          // Add the virtual entry to the explorer
          fileExplorer.appendChild(virtualEntry);

          // Create the main file list
          const fileList = document.createElement('ul');
          fileList.className = 'file-list';
          fileList.setAttribute('role', 'tree');
          fileList.setAttribute('aria-label', 'Project file tree');

          // Build hierarchical structure
          const websitePath = currentWebsite.path;
          const fileTree = await buildFileTree(files, websitePath);

          console.log('Built file tree:', fileTree);
          console.log('File tree length:', fileTree.length);

          // Render the file tree
          renderFileTree(fileTree, fileList);

          console.log('File explorer DOM after rendering:', fileList.innerHTML.substring(0, 200) + '...');

          // Add the file list to the explorer
          fileExplorer.appendChild(fileList);

          // File explorer populated successfully
        } catch (error) {
          console.error('Error loading website files:', error);
          // Re-throw for future error handler to catch
          throw error;
        }
      }

      // Initialize website loading - wait for proper website data
      async function initializeWebsite() {
        console.log('Initializing website editor...');

        // Show loading message immediately
        const fileExplorer = document.querySelector('.left-panel');
        fileExplorer.innerHTML =
          '<div style="padding: 16px; color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 8px;"><div style="width: 12px; height: 12px; border: 2px solid var(--text-secondary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>Waiting for website data...</div><style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>';

        // Don't try to populate file explorer yet - wait for load-website event
        // This prevents race conditions and wrong website name usage
        console.log('Waiting for load-website event with proper website data...');

        // Add a timeout to help debug if the event never fires
        setTimeout(() => {
          if (!currentWebsite) {
            console.error('❌ No load-website event received after 5 seconds. Debugging info:');
            console.error('  - ElectronAPI available:', !!window.electronAPI);
            console.error('  - Window location:', window.location.href);
            console.error('  - Document title:', document.title);

            const fileExplorer = document.querySelector('.left-panel');
            if (fileExplorer) {
              fileExplorer.innerHTML = `
                <div style="padding: 16px; color: var(--text-secondary); font-size: 12px;">
                  <p>⚠️ Website data not loaded</p>
                  <p>Waiting for Electron main process...</p>
                  <p>Check the console for more details.</p>
                  <button onclick="tryManualInit()" style="margin-top: 10px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Try Manual Load
                  </button>
                </div>
              `;
            }
          }
        }, 5000);
      }

      // Try to manually initialize with a fallback approach
      async function tryManualInit() {
        console.log('Attempting manual initialization...');

        try {
          // Try to derive website name from window location or title
          let websiteName = 'unknown';

          // Extract from file path if possible
          const locationPath = window.location.href;
          const match = locationPath.match(/\/([^\/]+)\/app\/ui\/templates/);
          if (match) {
            websiteName = match[1];
          } else {
            // Fallback to document title or ask user
            websiteName = document.title.replace(' - Website Editor', '') || 'test-website';
          }

          console.log('Attempting to load website:', websiteName);

          // Create a mock website object
          currentWebsite = {
            name: websiteName,
            path: `/path/to/${websiteName}`, // This will need to be corrected by the backend
          };

          // Try to populate file explorer
          await populateFileExplorer();
          console.log('Manual initialization successful');
        } catch (error) {
          console.error('Manual initialization failed:', error);
          const fileExplorer = document.querySelector('.left-panel');
          if (fileExplorer) {
            fileExplorer.innerHTML = `
              <div style="padding: 16px; color: var(--text-secondary); font-size: 12px;">
                <p>❌ Manual initialization failed</p>
                <p>Error: ${error.message}</p>
                <p>The Electron main process may need to be fixed.</p>
              </div>
            `;
          }
        }
      }

      // Event-based file loading system
      if (window.electronAPI) {
        console.log('✅ ElectronAPI available, setting up listeners');

        // Listen for website loading from main process
        window.electronAPI.on('load-website', async (websiteData) => {
          console.log('✅ Received load-website event:', websiteData);

          // Clear any previous state
          currentWebsite = websiteData;
          currentFilePath = null;
          currentFileContent = '';
          websiteFiles = [];

          try {
            // Populate file explorer with proper website data
            await populateFileExplorer();
            console.log('File explorer populated successfully');

            // Auto-load index.md if it exists in src directory
            try {
              await loadFileContent(`${websiteData.path}/src/index.md`);
              console.log('Auto-loaded index.md file');
            } catch (error) {
              console.log('No index.md file found to auto-load');
            }
          } catch (error) {
            console.error('Failed to load website files:', error);

            // Show error state in file explorer
            const fileExplorer = document.querySelector('.left-panel');
            fileExplorer.innerHTML = `<div style="padding: 16px; color: var(--error-color); font-size: 12px;">Failed to load files for ${websiteData.name}<br><small>Check console for details</small></div>`;
          }
        });

        // Listen for URL resolver ready events (for future implementation)
        window.electronAPI.on('url-resolver-ready', async (websiteName) => {
          console.log('URL resolver ready for:', websiteName);
          try {
            await populateFileExplorer();
          } catch (error) {
            console.error('Failed to reload files after URL resolver ready:', error);
            throw error;
          }
        });

        // Listen for file system changes that should trigger refresh
        window.electronAPI.on('website-files-changed', async (websiteName) => {
          console.log('Files changed for:', websiteName);
          try {
            await populateFileExplorer();
          } catch (error) {
            console.error('Failed to refresh files after change:', error);
            throw error;
          }
        });
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', initializeWebsite);

      // Also try initialization if DOM is already ready
      if (document.readyState !== 'loading') {
        initializeWebsite();
      }

      // ==========================================
      // FRONTMATTER EDITOR FUNCTIONALITY
      // ==========================================

      // Setup frontmatter editor
      function setupFrontmatterEditor() {
        const container = document.getElementById('frontmatter-editor');
        const applyButton = document.getElementById('apply-frontmatter');
        const resetButton = document.getElementById('reset-frontmatter');

        // Initialize JSON Editor with basic schema
        const schema = {
          type: 'object',
          title: 'Frontmatter',
          properties: {
            title: {
              type: 'string',
              title: 'Title',
              description: 'Page title',
            },
            date: {
              type: 'string',
              title: 'Date',
              format: 'date',
              description: 'Publication date',
            },
            layout: {
              type: 'string',
              title: 'Layout',
              description: 'Template layout to use',
            },
            tags: {
              type: 'array',
              title: 'Tags',
              items: {
                type: 'string',
              },
              description: 'Content tags',
            },
            description: {
              type: 'string',
              title: 'Description',
              description: 'Page description for SEO',
            },
          },
        };

        frontmatterEditor = new JSONEditor(container, {
          schema: schema,
          theme: 'bootstrap4',
          iconlib: 'fontawesome4',
          disable_edit_json: false,
          disable_properties: false,
          disable_array_reorder: false,
          array_controls_top: true,
          show_errors: 'always',
          no_additional_properties: false,
          required_by_default: false,
        });

        // Setup button handlers
        if (applyButton) {
          applyButton.addEventListener('click', applyFrontmatterChanges);
        }
        if (resetButton) {
          resetButton.addEventListener('click', resetFrontmatter);
        }

        // Clear initial display
        updateFrontmatterDisplay(null);
      }

      // Parse frontmatter from file content
      function parseFrontmatter(content) {
        if (!content || typeof content !== 'string') {
          return { frontmatter: {}, content: content || '' };
        }

        const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
        const match = content.match(frontmatterRegex);

        if (match) {
          try {
            const frontmatter = yaml.load(match[1]) || {};
            return {
              frontmatter: frontmatter,
              content: match[2],
            };
          } catch (error) {
            console.warn('Failed to parse YAML frontmatter:', error);
            showFrontmatterError('Invalid YAML syntax in frontmatter');
            return { frontmatter: {}, content: content };
          }
        }

        return { frontmatter: {}, content: content };
      }

      // Serialize frontmatter back to YAML
      function serializeFrontmatter(frontmatter, content) {
        if (!frontmatter || Object.keys(frontmatter).length === 0) {
          return content;
        }

        try {
          const yamlString = yaml.dump(frontmatter, {
            indent: 2,
            sortKeys: true,
            noRefs: true,
          });

          return `---\n${yamlString}---\n${content}`;
        } catch (error) {
          console.error('Failed to serialize frontmatter:', error);
          showFrontmatterError('Failed to convert frontmatter to YAML');
          return content;
        }
      }

      // Update frontmatter display when file changes
      function updateFrontmatterDisplay(filePath) {
        hideFrontmatterError();

        if (!filePath || !currentFileContent) {
          // No file selected - show empty state
          if (frontmatterEditor) {
            frontmatterEditor.setValue({});
            originalFrontmatter = {};
          }
          updateFileProperties(null);
          return;
        }

        // Parse frontmatter from current file
        const { frontmatter, content } = parseFrontmatter(currentFileContent);
        originalFrontmatter = JSON.parse(JSON.stringify(frontmatter)); // Deep copy

        // Update JSON editor
        if (frontmatterEditor) {
          frontmatterEditor.setValue(frontmatter);
        }

        // Update file properties
        updateFileProperties(filePath);
      }

      // Update file properties panel
      function updateFileProperties(filePath) {
        const fileTypeEl = document.getElementById('file-type');
        const wordCountEl = document.getElementById('word-count');
        const lastModifiedEl = document.getElementById('last-modified');
        const filePathEl = document.getElementById('file-path');

        if (!filePath) {
          // Clear properties
          if (fileTypeEl) fileTypeEl.textContent = '-';
          if (wordCountEl) wordCountEl.textContent = '-';
          if (lastModifiedEl) lastModifiedEl.textContent = '-';
          if (filePathEl) filePathEl.textContent = '-';
          return;
        }

        // Determine file type
        const ext = filePath.split('.').pop().toLowerCase();
        const fileType =
          {
            md: 'Markdown',
            markdown: 'Markdown',
            html: 'HTML',
            htm: 'HTML',
            js: 'JavaScript',
            ts: 'TypeScript',
            css: 'CSS',
            json: 'JSON',
            yml: 'YAML',
            yaml: 'YAML',
          }[ext] || 'Text';

        // Count words in content (excluding frontmatter)
        const { content } = parseFrontmatter(currentFileContent);
        const wordCount = content
          .trim()
          .split(/\s+/)
          .filter((word) => word.length > 0).length;

        // Update display
        if (fileTypeEl) fileTypeEl.textContent = fileType;
        if (wordCountEl) wordCountEl.textContent = wordCount.toString();
        if (lastModifiedEl) lastModifiedEl.textContent = 'Just now'; // Could be enhanced with real timestamps
        if (filePathEl) filePathEl.textContent = filePath;
      }

      // Apply frontmatter changes to file content
      async function applyFrontmatterChanges() {
        if (!frontmatterEditor || !currentFilePath) {
          return;
        }

        try {
          // Get current frontmatter from editor
          const newFrontmatter = frontmatterEditor.getValue();

          // Parse current file to get content without frontmatter
          const { content } = parseFrontmatter(currentFileContent);

          // Create new file content with updated frontmatter
          const newFileContent = serializeFrontmatter(newFrontmatter, content);

          // Update the file content
          currentFileContent = newFileContent;

          // Update editors
          if (aceEditor) {
            aceEditor.setValue(newFileContent, -1);
          }

          // Update original frontmatter to match applied changes
          originalFrontmatter = JSON.parse(JSON.stringify(newFrontmatter));

          hideFrontmatterError();
          console.log('Frontmatter applied successfully');
        } catch (error) {
          console.error('Failed to apply frontmatter changes:', error);
          showFrontmatterError('Failed to apply frontmatter changes');
        }
      }

      // Reset frontmatter to original state
      function resetFrontmatter() {
        if (!frontmatterEditor || !originalFrontmatter) {
          return;
        }

        try {
          frontmatterEditor.setValue(JSON.parse(JSON.stringify(originalFrontmatter)));
          hideFrontmatterError();
        } catch (error) {
          console.error('Failed to reset frontmatter:', error);
          showFrontmatterError('Failed to reset frontmatter');
        }
      }

      // Show frontmatter error
      function showFrontmatterError(message) {
        const errorEl = document.getElementById('frontmatter-error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }

      // Hide frontmatter error
      function hideFrontmatterError() {
        const errorEl = document.getElementById('frontmatter-error');
        if (errorEl) {
          errorEl.style.display = 'none';
        }
      }

      // Enhanced loadFileContent to update frontmatter
      const originalLoadFileContent = loadFileContent;
      loadFileContent = async function (filePath) {
        await originalLoadFileContent(filePath);

        // Update frontmatter display after loading file
        updateFrontmatterDisplay(filePath);
      };
    </script>
  </body>
</html>
