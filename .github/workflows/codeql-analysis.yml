# ABOUTME: CodeQL security analysis workflow for static application security testing
# ABOUTME: Runs CodeQL analysis on JavaScript/TypeScript code to detect security vulnerabilities

name: "CodeQL Security Analysis"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 2 * * 1'  # Run weekly on Mondays at 2:30 AM UTC
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to analyze (javascript, typescript, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - javascript
          - typescript

# Prevent concurrent CodeQL runs on the same ref
concurrency:
  group: codeql-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write  # For PR comments

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language: ${{ github.event.inputs.language == 'all' && fromJson('["javascript", "typescript"]') || github.event.inputs.language && fromJson(format('["{0}"]', github.event.inputs.language)) || fromJson('["javascript", "typescript"]') }}
        include:
          - language: javascript
            build-mode: none  # JavaScript doesn't need compilation
          - language: typescript
            build-mode: none  # TypeScript uses none build mode for CodeQL
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality
        build-mode: ${{ matrix.build-mode }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Cache CodeQL build outputs
      uses: actions/cache@v4
      with:
        path: |
          .cache/typescript
          **/*.tsbuildinfo
          **/dist
          **/build
        key: codeql-${{ runner.os }}-${{ matrix.language }}-${{ hashFiles('**/package-lock.json', '**/tsconfig.json') }}
        restore-keys: |
          codeql-${{ runner.os }}-${{ matrix.language }}-
          codeql-${{ runner.os }}-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
    
    - name: Create analysis summary
      if: always()
      run: |
        echo "## 🔍 CodeQL Security Analysis Results (${{ matrix.language }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **CodeQL analysis completed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📋 **Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review security alerts in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
        echo "2. Address any critical and high severity issues first" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Language:** ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build Mode:** ${{ matrix.build-mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**Analysis Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY